"""Exploit orchestration service for CyberForge.

Provides a unified interface for running offensive security scans
including SQL injection, XSS, directory bruteforce, nuclei templates,
web fuzzing, and credential testing.
"""

import asyncio
import logging
import uuid
from typing import Optional

from backend.models.exploit import (
    SQLiResult,
    XSSResult,
    DirResult,
    NucleiResult,
    FuzzResult,
    CredentialResult,
)
from backend.scanners.sqli_scanner import scan_sqli
from backend.scanners.xss_scanner import scan_xss
from backend.scanners.dir_bruteforce import scan_dirs
from backend.scanners.nuclei_scanner import scan_nuclei
from backend.scanners.web_fuzzer import scan_fuzz
from backend.scanners.credential_tester import scan_credentials
from backend.utils.progress import ProgressEmitter

logger = logging.getLogger(__name__)


class ExploitService:
    """Orchestrates offensive security scanning operations."""

    async def run_sqli(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[SQLiResult]:
        """Run SQL injection scan."""
        logger.info("Starting SQLi scan on %s", target)
        return await scan_sqli(target, progress_emitter)

    async def run_xss(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[XSSResult]:
        """Run XSS scan."""
        logger.info("Starting XSS scan on %s", target)
        return await scan_xss(target, progress_emitter)

    async def run_dir_bruteforce(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[DirResult]:
        """Run directory bruteforce."""
        logger.info("Starting directory scan on %s", target)
        return await scan_dirs(target, progress_emitter=progress_emitter)

    async def run_nuclei(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[NucleiResult]:
        """Run nuclei vulnerability scan."""
        logger.info("Starting nuclei scan on %s", target)
        return await scan_nuclei(target, progress_emitter)

    async def run_fuzz(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[FuzzResult]:
        """Run web fuzzer."""
        logger.info("Starting fuzzer on %s", target)
        return await scan_fuzz(target, progress_emitter=progress_emitter)

    async def run_credentials(
        self,
        target: str,
        scan_id: str | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> list[CredentialResult]:
        """Run credential tester."""
        logger.info("Starting credential test on %s", target)
        return await scan_credentials(target, progress_emitter=progress_emitter)

    async def run_strike_chain(
        self,
        target: str,
        modules: list[str] | None = None,
        progress_emitter: Optional[ProgressEmitter] = None,
    ) -> dict:
        """Run multiple exploit modules in parallel.

        Args:
            target: Target URL or host.
            modules: List of module names to run. Defaults to all.
            progress_emitter: Optional emitter for real-time progress.

        Returns:
            Dict with results keyed by module name.
        """
        all_modules = modules or ["sqli", "xss", "dirs", "nuclei", "fuzz", "creds"]

        if progress_emitter:
            await progress_emitter.emit(0, "running", f"Strike chain initiated on {target}", "strike_chain")

        tasks = {}
        if "sqli" in all_modules:
            tasks["sqli"] = scan_sqli(target)
        if "xss" in all_modules:
            tasks["xss"] = scan_xss(target)
        if "dirs" in all_modules:
            tasks["dirs"] = scan_dirs(target)
        if "nuclei" in all_modules:
            tasks["nuclei"] = scan_nuclei(target)
        if "fuzz" in all_modules:
            tasks["fuzz"] = scan_fuzz(target)
        if "creds" in all_modules:
            tasks["creds"] = scan_credentials(target)

        if progress_emitter:
            await progress_emitter.emit(10, "running", f"Running {len(tasks)} modules in parallel", "strike_chain")

        # Run all modules concurrently
        keys = list(tasks.keys())
        coros = list(tasks.values())
        raw_results = await asyncio.gather(*coros, return_exceptions=True)

        results = {}
        for key, result in zip(keys, raw_results):
            if isinstance(result, Exception):
                logger.error("Module %s failed: %s", key, result)
                results[key] = []
            else:
                results[key] = result

        if progress_emitter:
            total_findings = sum(len(v) for v in results.values())
            await progress_emitter.emit(100, "completed", f"Strike chain complete: {total_findings} total findings", "strike_chain")

        return results


# Module-level singleton
exploit_service = ExploitService()

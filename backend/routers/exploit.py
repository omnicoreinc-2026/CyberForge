"""Exploit module router for CyberForge.

Provides endpoints for SQL injection, XSS, directory bruteforce,
nuclei vulnerability scanning, web fuzzing, credential testing,
and the combined strike chain.
"""

import logging
import uuid
from typing import Any

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field

from backend.services.exploit_service import exploit_service
from backend.utils.progress import ProgressEmitter

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/exploit", tags=["exploit"])


class ExploitRequest(BaseModel):
    target: str = Field(..., min_length=1, max_length=2048)
    options: dict[str, Any] = Field(default_factory=dict)


class StrikeChainRequest(BaseModel):
    target: str = Field(..., min_length=1, max_length=2048)
    modules: list[str] = Field(
        default_factory=lambda: ["sqli", "xss", "dirs", "nuclei", "fuzz", "creds"],
    )
    options: dict[str, Any] = Field(default_factory=dict)


@router.post("/sqli", summary="SQL injection scan")
async def sqli_scan(request: ExploitRequest) -> dict:
    """Scan target for SQL injection vulnerabilities."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_sqli(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("SQLi scan failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/xss", summary="XSS scan")
async def xss_scan(request: ExploitRequest) -> dict:
    """Scan target for XSS vulnerabilities."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_xss(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("XSS scan failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/dirs", summary="Directory bruteforce")
async def dir_scan(request: ExploitRequest) -> dict:
    """Bruteforce directories on target."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_dir_bruteforce(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("Dir scan failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/nuclei", summary="Nuclei vulnerability scan")
async def nuclei_scan(request: ExploitRequest) -> dict:
    """Scan target with nuclei templates or Python fallback."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_nuclei(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("Nuclei scan failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/fuzz", summary="Web fuzzer")
async def fuzz_scan(request: ExploitRequest) -> dict:
    """Fuzz target URL with payloads."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_fuzz(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("Fuzz scan failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/creds", summary="Credential tester")
async def cred_scan(request: ExploitRequest) -> dict:
    """Test default credentials against target."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_credentials(request.target, scan_id)
        return {
            "scan_id": scan_id,
            "target": request.target,
            "total": len(results),
            "results": [r.model_dump() for r in results],
        }
    except Exception as exc:
        logger.exception("Credential test failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc


@router.post("/strike-chain", summary="Combined strike chain")
async def strike_chain(request: StrikeChainRequest) -> dict:
    """Run multiple exploit modules in parallel."""
    try:
        scan_id = str(uuid.uuid4())
        results = await exploit_service.run_strike_chain(request.target, request.modules)

        # Convert results to serializable dicts
        serialized = {}
        for key, items in results.items():
            serialized[key] = [r.model_dump() for r in items] if items else []

        total_findings = sum(len(v) for v in serialized.values())
        return {
            "scan_id": scan_id,
            "target": request.target,
            "modules": list(serialized.keys()),
            "total_findings": total_findings,
            **serialized,
        }
    except Exception as exc:
        logger.exception("Strike chain failed")
        raise HTTPException(status_code=500, detail=str(exc)) from exc

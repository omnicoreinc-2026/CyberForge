import { useState, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Bug, Search, ChevronDown, ChevronRight, ExternalLink } from 'lucide-react';
import { cn } from '@/lib/utils';
import { ApiClient, ApiClientError } from '@/lib/api-client';
import { SeverityBadge } from '@/components/shared/severity-badge';
import { formatDate, truncateString } from '@/lib/utils';
import type { CveLookupResponse, CveResult } from '@/types/vuln';
import type { ScanStatus } from '@/types/scan';

type SortField = 'cveId' | 'cvssScore' | 'publishedDate';
type SortDir = 'asc' | 'desc';

export function CveLookupPanel() {
  const [query, setQuery] = useState('');
  const [status, setStatus] = useState<ScanStatus>('idle');
  const [results, setResults] = useState<CveLookupResponse | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [expanded, setExpanded] = useState<Record<string, boolean>>({});
  const [sortField, setSortField] = useState<SortField>('cvssScore');
  const [sortDir, setSortDir] = useState<SortDir>('desc');

  const handleSearch = useCallback(async () => {
    if (!query.trim()) return;
    setStatus('running'); setError(null);
    try {
      const data = await ApiClient.post<CveLookupResponse>('/api/vuln/cve', { query: query.trim() });
      setResults(data); setStatus('complete');
    } catch (err) {
      setError(err instanceof ApiClientError ? err.message : 'CVE lookup failed'); setStatus('error');
    }
  }, [query]);

  const handleSort = useCallback((field: SortField) => {
    if (sortField === field) setSortDir((d) => (d === 'asc' ? 'desc' : 'asc'));
    else { setSortField(field); setSortDir('desc'); }
  }, [sortField]);

  const sorted: CveResult[] = results ? [...results.results].sort((a, b) => {
    let c: number;
    if (sortField === 'cvssScore') c = a.cvssScore - b.cvssScore;
    else c = String(a[sortField]).localeCompare(String(b[sortField]));
    return sortDir === 'asc' ? c : -c;
  }) : [];

  const si = (f: SortField) => (sortField === f ? (sortDir === 'asc' ? ' \u2191' : ' \u2193') : '');

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center gap-3">
        <input type="text" value={query} onChange={(e) => setQuery(e.target.value)}
          onKeyDown={(e) => { if (e.key === 'Enter') void handleSearch(); }}
          placeholder="Search CVE ID or keyword (e.g., CVE-2024-1234)" disabled={status === 'running'}
          className={cn('flex-1 rounded-lg border border-border bg-bg-secondary px-4 py-2.5 text-sm text-text-primary placeholder:text-text-muted font-mono outline-none transition-colors focus:border-accent focus:ring-1 focus:ring-accent/30 disabled:cursor-not-allowed disabled:opacity-50')} />
        <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => void handleSearch()} disabled={status === 'running' || !query.trim()}
          className={cn('flex items-center gap-2 rounded-lg bg-accent px-5 py-2.5 text-sm font-medium text-bg-primary disabled:cursor-not-allowed disabled:opacity-50 hover:shadow-[0_0_20px_rgba(0,212,255,0.3)]')}>
          <Search className="h-4 w-4" />{status === 'running' ? 'Searching...' : 'Search CVE'}
        </motion.button>
      </div>
      <AnimatePresence>{error && (<motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="glass-card border-danger/30 p-4 text-sm text-danger">{error}</motion.div>)}</AnimatePresence>
      {status === 'running' && (<motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex items-center justify-center gap-3 py-12"><div className="h-5 w-5 animate-spin rounded-full border-2 border-accent border-t-transparent" /><span className="text-sm text-text-secondary">Searching CVE database...</span></motion.div>)}
      {status === 'complete' && results && (
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex flex-col gap-2">
          <span className="text-sm text-text-secondary">Found <span className="font-mono font-semibold text-accent">{results.total}</span> results</span>
          <div className="glass-card overflow-hidden">
            <table className="w-full text-sm">
              <thead><tr className="border-b border-border text-left">
                <th onClick={() => handleSort('cveId')} className="cursor-pointer px-4 py-3 text-xs font-semibold uppercase tracking-wider text-text-muted hover:text-accent">CVE ID{si('cveId')}</th>
                <th className="px-4 py-3 text-xs font-semibold uppercase tracking-wider text-text-muted">Description</th>
                <th onClick={() => handleSort('cvssScore')} className="cursor-pointer px-4 py-3 text-xs font-semibold uppercase tracking-wider text-text-muted hover:text-accent">CVSS{si('cvssScore')}</th>
                <th onClick={() => handleSort('publishedDate')} className="cursor-pointer px-4 py-3 text-xs font-semibold uppercase tracking-wider text-text-muted hover:text-accent">Published{si('publishedDate')}</th>
                <th className="w-8 px-4 py-3"></th>
              </tr></thead>
              <tbody>{sorted.map((cve) => (
                <AnimatePresence key={cve.cveId}>
                  <motion.tr initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="border-b border-border/50 hover:bg-accent-dim/30 cursor-pointer" onClick={() => setExpanded((p) => ({ ...p, [cve.cveId]: !p[cve.cveId] }))}>
                    <td className="px-4 py-2.5 font-mono text-accent whitespace-nowrap">{cve.cveId}</td>
                    <td className="px-4 py-2.5 text-text-secondary text-xs max-w-sm">{truncateString(cve.description, 100)}</td>
                    <td className="px-4 py-2.5"><SeverityBadge severity={cve.severity} /></td>
                    <td className="px-4 py-2.5 font-mono text-xs text-text-muted whitespace-nowrap">{formatDate(cve.publishedDate)}</td>
                    <td className="px-4 py-2.5 text-text-muted">{expanded[cve.cveId] ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}</td>
                  </motion.tr>
                  {expanded[cve.cveId] && (
                    <motion.tr initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                      <td colSpan={5} className="bg-bg-secondary/50 px-4 py-3">
                        <div className="flex flex-col gap-2">
                          <p className="text-xs text-text-secondary leading-relaxed">{cve.description}</p>
                          {cve.affectedProducts.length > 0 && (<div><span className="text-xs font-semibold text-text-muted">Affected:</span><div className="mt-1 flex flex-wrap gap-1">{cve.affectedProducts.map((p) => (<span key={p} className="rounded bg-bg-card px-1.5 py-0.5 text-xs text-text-muted">{p}</span>))}</div></div>)}
                          {cve.references.length > 0 && (<div className="flex flex-wrap gap-2">{cve.references.map((r) => (<a key={r.url} href={r.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-xs text-accent hover:underline"><ExternalLink className="h-3 w-3" />{r.source}</a>))}</div>)}
                        </div>
                      </td>
                    </motion.tr>
                  )}
                </AnimatePresence>
              ))}</tbody>
            </table>
          </div>
        </motion.div>
      )}
      {status === 'idle' && (<motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col items-center justify-center gap-3 py-16 text-text-muted"><Bug className="h-10 w-10 opacity-30" /><p className="text-sm">Search for CVE IDs or keywords</p></motion.div>)}
    </div>
  );
}

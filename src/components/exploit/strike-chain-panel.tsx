import { useState, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Crosshair, Search, ChevronDown, ChevronRight } from 'lucide-react';
import { cn } from '@/lib/utils';
import { ApiClient, ApiClientError } from '@/lib/api-client';
import { ScanProgress } from '@/components/shared/scan-progress';
import type { StrikeChainResponse } from '@/types/exploit';
import type { ScanStatus } from '@/types/scan';

type StrikeModule = 'sqli' | 'xss' | 'dirs' | 'nuclei' | 'fuzz' | 'creds';

const modules: { id: StrikeModule; label: string }[] = [
  { id: 'sqli', label: 'SQL Injection' },
  { id: 'xss', label: 'Cross-Site Scripting' },
  { id: 'dirs', label: 'Directory Bruteforce' },
  { id: 'nuclei', label: 'Nuclei Templates' },
  { id: 'fuzz', label: 'Fuzzer' },
  { id: 'creds', label: 'Credential Testing' },
];

export function StrikeChainPanel() {
  const [target, setTarget] = useState('');
  const [selectedModules, setSelectedModules] = useState<Set<StrikeModule>>(new Set(['sqli', 'xss', 'dirs', 'nuclei', 'fuzz', 'creds']));
  const [status, setStatus] = useState<ScanStatus>('idle');
  const [progress, setProgress] = useState(0);
  const [results, setResults] = useState<StrikeChainResponse | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set());

  const toggleModule = useCallback((mod: StrikeModule) => {
    setSelectedModules((prev) => {
      const next = new Set(prev);
      if (next.has(mod)) next.delete(mod); else next.add(mod);
      return next;
    });
  }, []);

  const toggleSection = useCallback((section: string) => {
    setExpandedSections((prev) => {
      const next = new Set(prev);
      if (next.has(section)) next.delete(section); else next.add(section);
      return next;
    });
  }, []);

  const handleScan = useCallback(async () => {
    if (!target.trim() || selectedModules.size === 0) return;
    setStatus('running'); setError(null); setProgress(0); setExpandedSections(new Set());
    const iv = setInterval(() => setProgress((p) => Math.min(p + Math.random() * 5, 95)), 600);
    try {
      const data = await ApiClient.post<StrikeChainResponse>('/api/exploit/strike-chain', {
        target: target.trim(),
        modules: Array.from(selectedModules),
      });
      clearInterval(iv); setProgress(100); setResults(data); setStatus('complete');
      // Auto-expand sections with results
      const autoExpand = new Set<string>();
      if (data.sqli.length > 0) autoExpand.add('sqli');
      if (data.xss.length > 0) autoExpand.add('xss');
      if (data.dirs.length > 0) autoExpand.add('dirs');
      if (data.nuclei.length > 0) autoExpand.add('nuclei');
      if (data.fuzz.length > 0) autoExpand.add('fuzz');
      if (data.credentials.length > 0) autoExpand.add('credentials');
      setExpandedSections(autoExpand);
    } catch (err) {
      clearInterval(iv); setError(err instanceof ApiClientError ? err.message : 'Strike chain failed'); setStatus('error');
    }
  }, [target, selectedModules]);

  const sectionData = results ? [
    { key: 'sqli', label: 'SQL Injection', count: results.sqli.length, items: results.sqli },
    { key: 'xss', label: 'Cross-Site Scripting', count: results.xss.length, items: results.xss },
    { key: 'dirs', label: 'Directory Bruteforce', count: results.dirs.length, items: results.dirs },
    { key: 'nuclei', label: 'Nuclei Templates', count: results.nuclei.length, items: results.nuclei },
    { key: 'fuzz', label: 'Fuzzer', count: results.fuzz.length, items: results.fuzz },
    { key: 'credentials', label: 'Credential Testing', count: results.credentials.length, items: results.credentials },
  ] : [];

  const totalFindings = sectionData.reduce((sum, s) => sum + s.count, 0);

  return (
    <div className="flex flex-col gap-4">
      {/* Target input */}
      <div className="flex items-center gap-3">
        <input type="text" value={target} onChange={(e) => setTarget(e.target.value)}
          onKeyDown={(e) => { if (e.key === 'Enter') void handleScan(); }}
          placeholder="Target URL (e.g. http://target.com/)" disabled={status === 'running'}
          className={cn('flex-1 rounded-lg border border-border bg-bg-secondary px-4 py-2.5 text-sm text-text-primary placeholder:text-text-muted font-mono outline-none transition-colors focus:border-accent focus:ring-1 focus:ring-accent/30 disabled:cursor-not-allowed disabled:opacity-50')} />
        <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => void handleScan()} disabled={status === 'running' || !target.trim() || selectedModules.size === 0}
          className={cn('flex items-center gap-2 rounded-lg bg-accent px-5 py-2.5 text-sm font-bold text-bg-primary uppercase tracking-wider disabled:cursor-not-allowed disabled:opacity-50 hover-glow-accent')}>
          <Search className="h-4 w-4" />{status === 'running' ? 'Striking...' : 'LAUNCH STRIKE'}
        </motion.button>
      </div>

      {/* Module checkboxes */}
      <div className="glass-card p-4">
        <h3 className="mb-3 text-xs font-semibold uppercase tracking-wider text-text-muted">Select Modules</h3>
        <div className="grid grid-cols-2 gap-2 sm:grid-cols-3">
          {modules.map((mod) => (
            <label key={mod.id} className={cn(
              'flex cursor-pointer items-center gap-2.5 rounded-lg border px-3 py-2 text-sm transition-all',
              selectedModules.has(mod.id)
                ? 'border-accent/50 bg-accent/10 text-text-primary'
                : 'border-border bg-bg-secondary text-text-muted hover:border-border hover:bg-bg-card',
              status === 'running' && 'cursor-not-allowed opacity-50',
            )}>
              <input type="checkbox" checked={selectedModules.has(mod.id)} onChange={() => toggleModule(mod.id)} disabled={status === 'running'}
                className="h-3.5 w-3.5 rounded border-border bg-bg-secondary text-accent accent-accent" />
              {mod.label}
            </label>
          ))}
        </div>
      </div>

      {/* Error */}
      <AnimatePresence>{error && (<motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="glass-card border-danger/30 p-4 text-sm text-danger">{error}</motion.div>)}</AnimatePresence>

      {/* Running */}
      {status === 'running' && (<motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col items-center gap-4 py-12"><ScanProgress progress={progress} currentTask="Running coordinated strike..." /></motion.div>)}

      {/* Results */}
      {status === 'complete' && results && (
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex flex-col gap-4">
          <div className="glass-card flex items-center gap-2 px-4 py-2">
            <span className="text-xs text-text-muted">Total Findings:</span>
            <span className="font-mono text-sm font-semibold text-danger">{totalFindings}</span>
          </div>

          {/* Collapsible sections */}
          {sectionData.map((section) => (
            <motion.div key={section.key} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="glass-card overflow-hidden">
              <button onClick={() => toggleSection(section.key)}
                className="flex w-full items-center justify-between px-4 py-3 text-left hover:bg-accent-dim/20 transition-colors">
                <div className="flex items-center gap-3">
                  {expandedSections.has(section.key) ? <ChevronDown className="h-4 w-4 text-text-muted" /> : <ChevronRight className="h-4 w-4 text-text-muted" />}
                  <span className="text-sm font-medium text-text-primary">{section.label}</span>
                </div>
                <span className={cn('rounded-full border px-2.5 py-0.5 text-xs font-medium', section.count > 0 ? 'text-danger bg-danger/10 border-danger/30' : 'text-text-muted bg-bg-secondary border-border')}>{section.count}</span>
              </button>
              <AnimatePresence>
                {expandedSections.has(section.key) && section.count > 0 && (
                  <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} transition={{ duration: 0.2 }} className="overflow-hidden">
                    <div className="border-t border-border">
                      {section.key === 'sqli' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Parameter</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Type</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">DBMS</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Evidence</th>
                        </tr></thead><tbody>{results.sqli.map((r, i) => (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs">{r.parameter}</td>
                            <td className="px-4 py-2"><span className="rounded-full border border-danger/30 bg-danger/10 px-2 py-0.5 text-xs text-danger">{r.payload_type}</span></td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.dbms || '-'}</td>
                            <td className="px-4 py-2 text-text-muted text-xs">{r.evidence}</td>
                          </tr>))}</tbody></table>
                      )}
                      {section.key === 'xss' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Parameter</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Payload</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Type</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Evidence</th>
                        </tr></thead><tbody>{results.xss.map((r, i) => (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs">{r.parameter}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs max-w-[200px] truncate">{r.payload}</td>
                            <td className="px-4 py-2"><span className="rounded-full border border-warning/30 bg-warning/10 px-2 py-0.5 text-xs text-warning">{r.xss_type}</span></td>
                            <td className="px-4 py-2 text-text-muted text-xs">{r.evidence}</td>
                          </tr>))}</tbody></table>
                      )}
                      {section.key === 'dirs' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">URL</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Status</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Size</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Redirect</th>
                        </tr></thead><tbody>{results.dirs.map((r, i) => (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs max-w-[250px] truncate">{r.url}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.status_code}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.size} B</td>
                            <td className="px-4 py-2 font-mono text-text-muted text-xs max-w-[200px] truncate">{r.redirect_url || '-'}</td>
                          </tr>))}</tbody></table>
                      )}
                      {section.key === 'nuclei' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Template</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Name</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Severity</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Matched URL</th>
                        </tr></thead><tbody>{results.nuclei.map((r, i) => {
                          const sevColors: Record<string, string> = { critical: 'text-danger bg-danger/10 border-danger/30', high: 'text-high bg-high/10 border-high/30', medium: 'text-warning bg-warning/10 border-warning/30', low: 'text-success bg-success/10 border-success/30', info: 'text-info bg-info/10 border-info/30' };
                          return (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs">{r.template_id}</td>
                            <td className="px-4 py-2 text-text-primary text-xs">{r.name}</td>
                            <td className="px-4 py-2"><span className={cn('rounded-full border px-2 py-0.5 text-xs font-medium', sevColors[r.severity.toLowerCase()] ?? 'text-text-muted bg-bg-secondary border-border')}>{r.severity}</span></td>
                            <td className="px-4 py-2 font-mono text-text-muted text-xs max-w-[200px] truncate">{r.matched_url}</td>
                          </tr>);
                        })}</tbody></table>
                      )}
                      {section.key === 'fuzz' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Payload</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Status</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Length</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Anomaly</th>
                        </tr></thead><tbody>{results.fuzz.map((r, i) => (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs max-w-[200px] truncate">{r.payload}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.status_code}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.response_length}</td>
                            <td className="px-4 py-2"><span className={cn('rounded-full border px-2 py-0.5 text-xs font-medium', r.anomaly ? 'text-danger bg-danger/10 border-danger/30' : 'text-success bg-success/10 border-success/30')}>{r.anomaly ? 'Yes' : 'No'}</span></td>
                          </tr>))}</tbody></table>
                      )}
                      {section.key === 'credentials' && (
                        <table className="w-full text-sm"><thead><tr className="border-b border-border/50 text-left">
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Username</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Password</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Service</th>
                          <th className="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Success</th>
                        </tr></thead><tbody>{results.credentials.map((r, i) => (
                          <tr key={i} className="border-b border-border/30 hover:bg-accent-dim/20">
                            <td className="px-4 py-2 font-mono text-accent text-xs">{r.username}</td>
                            <td className="px-4 py-2 font-mono text-text-secondary text-xs">{r.password}</td>
                            <td className="px-4 py-2 text-text-secondary text-xs">{r.service}</td>
                            <td className="px-4 py-2"><span className={cn('rounded-full border px-2 py-0.5 text-xs font-medium', r.success ? 'text-success bg-success/10 border-success/30' : 'text-danger bg-danger/10 border-danger/30')}>{r.success ? 'Success' : 'Failed'}</span></td>
                          </tr>))}</tbody></table>
                      )}
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </motion.div>
          ))}
        </motion.div>
      )}

      {/* Idle state */}
      {status === 'idle' && (<motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col items-center justify-center gap-3 py-16 text-text-muted"><Crosshair className="h-10 w-10 opacity-30" /><p className="text-sm">Select modules and launch a coordinated strike</p></motion.div>)}
    </div>
  );
}
